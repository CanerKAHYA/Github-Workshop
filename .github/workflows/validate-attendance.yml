# Yoklama PR'larÄ±nÄ± DoÄŸrulama Workflow'u
name: Validate Attendance PR

on:
  pull_request:
    paths:
      - 'ATTENDANCE.md'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-email:
    name: ğŸ“§ E-posta Format KontrolÃ¼
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” E-posta FormatÄ±nÄ± DoÄŸrula
        id: validate
        run: |
          echo "ğŸ” ATTENDANCE.md deÄŸiÅŸiklikleri kontrol ediliyor..."
          
          # PR'daki deÄŸiÅŸiklikleri al (sadece eklenen satÄ±rlar)
          ADDED_LINES=$(git diff origin/${{ github.base_ref }}...HEAD -- ATTENDANCE.md | grep "^+" | grep -v "^+++" | sed 's/^+//')
          
          echo "ğŸ“ Eklenen satÄ±rlar:"
          echo "$ADDED_LINES"
          
          # E-posta regex pattern - @ iÅŸaretinden sonrasÄ±nÄ± kabul eder
          EMAIL_PATTERN='^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
          
          VALID=true
          INVALID_EMAILS=""
          VALID_EMAILS=""
          
          while IFS= read -r line; do
            # BoÅŸ satÄ±rlarÄ± ve yorum satÄ±rlarÄ±nÄ± atla
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*$ ]] || [[ "$line" =~ ^# ]] || [[ "$line" =~ ^\<\!-- ]] || [[ "$line" =~ ^\` ]]; then
              continue
            fi
            
            # Sadece e-posta iÃ§eren satÄ±rlarÄ± kontrol et
            TRIMMED=$(echo "$line" | xargs)
            
            if [[ "$TRIMMED" =~ $EMAIL_PATTERN ]]; then
              VALID_EMAILS="$VALID_EMAILS\nâœ… $TRIMMED"
              echo "âœ… GeÃ§erli e-posta: $TRIMMED"
            else
              # EÄŸer satÄ±r bir e-posta gibi gÃ¶rÃ¼nÃ¼yorsa (@ iÃ§eriyorsa) ama format yanlÄ±ÅŸsa
              if [[ "$TRIMMED" == *"@"* ]]; then
                VALID=false
                INVALID_EMAILS="$INVALID_EMAILS\nâŒ $TRIMMED"
                echo "âŒ GeÃ§ersiz e-posta formatÄ±: $TRIMMED"
              fi
            fi
          done <<< "$ADDED_LINES"
          
          if [ "$VALID" = true ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "valid_emails=$VALID_EMAILS" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ‰ TÃ¼m e-postalar geÃ§erli formatta!"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "invalid_emails=$INVALID_EMAILS" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ BazÄ± e-postalar geÃ§ersiz formatta!"
          fi

      - name: âœ… BaÅŸarÄ±lÄ± - Yorum Ekle
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Yoklama DoÄŸrulamasÄ± BaÅŸarÄ±lÄ±!

            E-posta formatÄ±nÄ±z geÃ§erli. PR merge edilmeye hazÄ±r! ğŸ‰

            ---
            *Bu otomatik bir mesajdÄ±r. GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur.*`
            })

      - name: âŒ BaÅŸarÄ±sÄ±z - Yorum Ekle
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Yoklama DoÄŸrulamasÄ± BaÅŸarÄ±sÄ±z

            E-posta formatÄ±nÄ±z geÃ§ersiz. LÃ¼tfen aÅŸaÄŸÄ±daki formata uygun ÅŸekilde dÃ¼zeltin:

            \`\`\`
            ogrenci_no@ogr.cbu.edu.tr
            \`\`\`

            **Ã–rnek:** \`210316011@ogr.cbu.edu.tr\`

            ---
            *Bu otomatik bir mesajdÄ±r. GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur.*`
            })

      - name: ğŸš« GeÃ§ersiz Format Ä°Ã§in Workflow'u BaÅŸarÄ±sÄ±z Yap
        if: steps.validate.outputs.valid == 'false'
        run: |
          echo "âŒ E-posta format doÄŸrulamasÄ± baÅŸarÄ±sÄ±z!"
          exit 1
